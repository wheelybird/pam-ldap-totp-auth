FROM ubuntu:24.04

# Install build dependencies
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        build-essential \
        gcc \
        make \
        libpam0g-dev \
        libldap2-dev \
        liboath-dev && \
    rm -rf /var/lib/apt/lists/*

# Copy PAM module source
COPY . /build/pam-ldap-totp-auth
WORKDIR /build/pam-ldap-totp-auth

# Build the PAM module
RUN make clean && make && echo "✓ PAM module built successfully"

# Build only the challenge-response test
RUN cd tests && \
    mkdir -p obj && \
    gcc -Wall -Wextra -O0 -g -I../include -I. -c ../src/config.c -o obj/config.o && \
    gcc -Wall -Wextra -O0 -g -I../include -I. -c ../src/security_utils.c -o obj/security_utils.o && \
    gcc -Wall -Wextra -O0 -g -I../include -I. -o test_challenge_response \
        test_challenge_response.c obj/config.o obj/security_utils.o \
        -lpam -lldap -llber -loath && \
    echo "✓ Challenge-response tests built successfully"

# Run the test
CMD ["/build/pam-ldap-totp-auth/tests/test_challenge_response"]
