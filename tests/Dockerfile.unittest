FROM ubuntu:24.04

# Install build and test dependencies
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        build-essential \
        gcc \
        make \
        libpam0g-dev \
        libldap2-dev \
        liboath-dev \
        check \
        libsubunit-dev && \
    rm -rf /var/lib/apt/lists/*

# Copy PAM module source
COPY . /build/pam-ldap-totp-auth
WORKDIR /build/pam-ldap-totp-auth

# Build the PAM module
RUN make clean && make

# Build and run unit tests
RUN cd tests && make clean && make

# Run all tests
CMD ["tests/run-all-tests.sh"]
